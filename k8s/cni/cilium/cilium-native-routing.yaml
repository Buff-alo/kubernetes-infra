# cilium-native-routing.yaml
---
global:
  cluster:
    name: "kls-multicloud"
    id: 1
  image:
    registry: "quay.io/cilium"
    tag: "v1.16.3"                  # LTS Nov 2025

clusterMesh:
  enabled: false

# ─────────────────────── CNI & KUBE-PROXY ───────────────────────
cni:
  chainingMode: "nil"              # K3s has no prior CNI
  exclusive: true
  customConf: true

kubeProxyReplacement: true         # eBPF kube-proxy (recommended)

# ─────────────────────── MASQUERADE (MUST BE OFF) ───────────────────────
enableIPv4Masquerade: false        # ← CRITICAL
enableIPv6Masquerade: false
bpf:
  masquerade: false                # ← CRITICAL
enable-bpf-masquerade: false       # ← CRITICAL (this one is sneaky)

# ─────────────────────── NATIVE ROUTING (the magic) ───────────────────────
routingMode: "native"                # ← kernel decides routes
endpointRoutes:
  enabled: false                   # ← let Tailscale own the routes
autoDirectNodeRoutes: false         # ← adds direct /32 routes for same-node pods
ipv4NativeRoutingCIDR: "10.42.0.0/16"   # ← exact pod CIDR

# ─────────────────────── MTU (Tailscale is 1280, but 1220 is safe) ───────────────────────
MTU: 1220

# ─────────────────────── IPAM ───────────────────────
ipam:
  mode: kubernetes
ipv4:
  enabled: true
cluster:
  pool:
    ipv4:
      cidr: "10.42.0.0/16"
      blockSize: 24

# ─────────────────────── K8S API VIA TAILSCALE ───────────────────────
k8sServiceHost: "100.118.120.5"
k8sServicePort: 6443

# ─────────────────────── DISABLE CONFLICTING FEATURES ───────────────────────
enableBandwidthManager: false
enableHostReachableServices: false
enableNetfilterController: false
enableL7Proxy: false

# ─────────────────────── PERFORMANCE & SAFETY ───────────────────────
nodeInit:
  enabled: true
rollOutCiliumPods: true
upgradeCompatibility: "1.15"

resources:
  requests:
    cpu: "150m"
    memory: "192Mi"
  limits:
    cpu: "800m"
    memory: "512Mi"

# ─────────────────────── OBSERVABILITY (optional) ───────────────────────
hubble:
  enabled: false
prometheus:
  enabled: false
