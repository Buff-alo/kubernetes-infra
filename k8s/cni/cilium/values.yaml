---
# ────────────────────────────────────────────────────────────────
# GLOBAL & CLUSTER IDENTIFIERS
# ────────────────────────────────────────────────────────────────
global:
  cluster:
    name: "kls-multicloud"          # ← Change if you have multiple clusters
    id: 1
  image:
    registry: "quay.io/cilium"      # ← Quay is faster & more reliable than Docker Hub
    tag: "v1.16.3"                  # ← Latest stable as of Nov 2025 (LTS)

# ────────────────────────────────────────────────────────────────
# CNI & KUBE-PROXY
# ────────────────────────────────────────────────────────────────
cni:
  chainingMode: none                # Required: K3s has no prior CNI
  exclusive: false

kubeProxyReplacement: strict       # Cilium replaces kube-proxy (eBPF)

# ────────────────────────────────────────────────────────────────
# KUBE-API ACCESS (via Tailscale)
# ────────────────────────────────────────────────────────────────
k8sServiceHost: "100.64.0.1"       # ← CONTROL PLANE TAILSCALE IP
k8sServicePort: 6443

# ────────────────────────────────────────────────────────────────
# NETWORKING: Tailscale-native (no tunnel)
# ────────────────────────────────────────────────────────────────
tunnel: disabled                   # ← Critical: use Tailscale WireGuard
autoDirectNodeRoutes: true         # Adds host routes for pod CIDRs
endpointRoutes:
  enabled: true

# Use Tailscale interface for pod traffic
devices: "tailscale0"

# Optional: MTU fix (Tailscale defaults to 1280)
bpf:
  masquerade: true
  mtu: 1280

# ────────────────────────────────────────────────────────────────
# ENCRYPTION: Double encryption optional
# ────────────────────────────────────────────────────────────────
encryption:
  enabled: false                   # ← Tailscale already encrypts
  # type: wireguard               # ← Only if you want Cilium-level encryption
  # nodeEncryption: true

# ────────────────────────────────────────────────────────────────
# IPAM & POD NETWORK
# ────────────────────────────────────────────────────────────────
ipam:
  mode: kubernetes                 # K3s manages pod IPs

cluster:
  pool:
    ipv4:
      cidr: "10.42.0.0/16"         # ← Must match K3s --cluster-cidr
    ipv4:
      mask: "24"

# ────────────────────────────────────────────────────────────────
# NODE INIT (for cloud nodes)
# ────────────────────────────────────────────────────────────────
nodeInit:
  enabled: true                    # Restarts nodes if needed (safe on reboot)

# ────────────────────────────────────────────────────────────────
# AGENT & PERFORMANCE
# ────────────────────────────────────────────────────────────────
agent:
  accessLog:
    enabled: false               

resources:
  requests:
    cpu: "150m"
    memory: "192Mi"
  limits:
    cpu: "400m"
    memory: "384Mi"

# ────────────────────────────────────────────────────────────────
# HUBBLE: Observability
# ────────────────────────────────────────────────────────────────
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true
    ingress:
      enabled: false           # We'll expose via port-forward or Tailscale
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - icmp
      - http

# ────────────────────────────────────────────────────────────────
# PROMETHEUS
# ────────────────────────────────────────────────────────────────
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true

operator:
  prometheus:
    enabled: true
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "128Mi"

# ────────────────────────────────────────────────────────────────
# SAFETY & COMPATIBILITY
# ────────────────────────────────────────────────────────────────
rollOutCiliumPods: true
upgradeCompatibility: "1.15"

# Disable features that conflict with Tailscale
enableNetfilterController: false
enableBandwidthManager: false
enableHostReachableServices: false