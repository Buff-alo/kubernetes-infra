
# cilium values.yaml for K3s with Tailscale networking
---
# ────────────────────────────────────────────────────────────────
# GLOBAL & CLUSTER IDENTIFIERS
# ────────────────────────────────────────────────────────────────
global:
  cluster:
    name: "kls-multicloud"          # ← Change if you have multiple clusters
    id: 1
  image:
    registry: "quay.io/cilium"      # ← Quay is faster & more reliable than Docker Hub
    tag: "v1.16.3"                  # ← Latest stable as of Nov 2025 (LTS)


clusterMesh:
  enabled: false
# ────────────────────────────────────────────────────────────────
# CNI & KUBE-PROXY
# ────────────────────────────────────────────────────────────────
cni:
  chainingMode: none                # Required: K3s has no prior CNI
  exclusive: false

kubeProxyReplacement: true       # Cilium replaces kube-proxy (eBPF)

# ────────────────────────────────────────────────────────────────
# KUBE-API ACCESS (via Tailscale)
# ────────────────────────────────────────────────────────────────
k8sServiceHost: "100.118.120.5"       # ← CONTROL PLANE TAILSCALE IP
k8sServicePort: 6443

# ────────────────────────────────────────────────────────────────
# NETWORKING: Tailscale-native (no tunnel)
# ────────────────────────────────────────────────────────────────
#tunnel: disabled                   # ← Critical: use Tailscale WireGuard
endpointRoutes:
  enabled: true

k8s:
  requireIPv4PodCIDR: true

# Use Tailscale interface for pod traffic
devices: "tailscale0"

enable-bpf-masquerade:  false

auto-direct-node-routes: false

routing-mode: "native"

tunnel-protocol: "vxlan"
# ────────────────────────────────────────────────────────────────
# ENCRYPTION: Double encryption optional
# ────────────────────────────────────────────────────────────────
encryption:
  enabled: false             # ← Tailscale already encrypts
  # type: wireguard          # ← Only if you want Cilium-level encryption
  # nodeEncryption: true

# ────────────────────────────────────────────────────────────────
# IPAM & POD NETWORK
# ────────────────────────────────────────────────────────────────
ipam:
  mode: kubernetes                 # K3s manages pod IPs

ipv4:
  enabled: true

cluster:
  pool:
    ipv4:
      cidr: "10.42.0.0/16"         # ← Must match K3s --cluster-cidr
      mask: "24"

# ────────────────────────────────────────────────────────────────
# NODE INIT (for cloud nodes)
# ────────────────────────────────────────────────────────────────
nodeInit:
  enabled: true                    # Restarts nodes if needed (safe on reboot)

# ────────────────────────────────────────────────────────────────
# AGENT & PERFORMANCE
# ────────────────────────────────────────────────────────────────
accessLog:
  enabled: false               

resources:
  requests:
    cpu: "150m"
    memory: "192Mi"
  limits:
    cpu: "400m"
    memory: "384Mi"

# ────────────────────────────────────────────────────────────────
# HUBBLE: Observability
# ────────────────────────────────────────────────────────────────
hubble:
  enabled: true
  relay:
    enabled: true
  ui:
    enabled: true
    ingress:
      enabled: false           # We'll expose via port-forward or Tailscale
  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - icmp
      - http

# ────────────────────────────────────────────────────────────────
# PROMETHEUS
# ────────────────────────────────────────────────────────────────
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    trustCRDsExist: true

operator:
  prometheus:
    enabled: true
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "128Mi"

# ────────────────────────────────────────────────────────────────
# SAFETY & COMPATIBILITY
# ────────────────────────────────────────────────────────────────
rollOutCiliumPods: true
upgradeCompatibility: "1.15"

# Disable features that conflict with Tailscale
enableNetfilterController: false
enableBandwidthManager: false
enableHostReachableServices: false
