# cilium values.yaml for K3s with Tailscale networking
---
# ────────────────────────────────────────────────────────────────
# GLOBAL & CLUSTER IDENTIFIERS
# ────────────────────────────────────────────────────────────────
global:
  cluster:
    name: "kls-multicloud" # ← Change if you have multiple clusters
    id: 1
  image:
    registry: "quay.io/cilium" # ← Quay is faster & more reliable than Docker Hub
    tag: "v1.16.3" # ← Latest stable as of Nov 2025 (LTS)

clusterMesh:
  enabled: false
# ────────────────────────────────────────────────────────────────
# CNI & KUBE-PROXY
# ────────────────────────────────────────────────────────────────
cni:
  chainingMode: none # Required: K3s has no prior CNI
  exclusive: false

kubeProxyReplacement: true # Cilium replaces kube-proxy (eBPF)

# ────────────────────────────────────────────────────────────────
# KUBE-API ACCESS (via Tailscale)
# ────────────────────────────────────────────────────────────────
k8sServiceHost: "100.118.120.5" # ← CONTROL PLANE TAILSCALE IP
k8sServicePort: 6443

# ────────────────────────────────────────────────────────────────
# NETWORKING: Tailscale-native (no tunnel)
# ────────────────────────────────────────────────────────────────
MTU: 1500

k8s:
  requireIPv4PodCIDR: true

endpointRoutes:
  enabled: true

# Use Tailscale interface for pod traffic
routing-mode: "tunnel" # 'native' routing via Tailscale
tunnel-protocol: "vxlan"  # vxlan for tunnel encapsulation or 'none' for native
devices: "tailscale0" # Tailscale interface for native routing or none for vxlan
ipv4NativeRoutingCIDR: "10.42.0.0/16" # Your pod CIDR for native routing

enable-bpf-masquerade: false # True for native routing, false for vxlan
auto-direct-node-routes: false # True for native routing, false for vxlan

# ────────────────────────────────────────────────────────────────
# ENCRYPTION: Double encryption optional
# ────────────────────────────────────────────────────────────────
encryption:
  enabled: false # ← Tailscale already encrypts
  # type: wireguard          # ← Only if you want Cilium-level encryption
  # nodeEncryption: true

# ────────────────────────────────────────────────────────────────
# IPAM & POD NETWORK
# ────────────────────────────────────────────────────────────────
ipam: kubernetes # K3s manages pod IPs

ipv4:
  enabled: true

cluster:
  pool:
    ipv4:
      cidr: "10.42.0.0/16" # ← Must match K3s --cluster-cidr

# ────────────────────────────────────────────────────────────────
# NODE INIT (for cloud nodes)
# ────────────────────────────────────────────────────────────────
nodeInit:
  enabled: true # Restarts nodes if needed (safe on reboot)

# ────────────────────────────────────────────────────────────────
# AGENT & PERFORMANCE
# ────────────────────────────────────────────────────────────────
accessLog:
  enabled: false

bpf:
  mapDynamicSizeRatio: "0.0025"

monitor:
  queueSize: 32768

resources:
  requests:
    cpu: "150m"
    memory: "192Mi"
  limits:
    cpu: "400m"
    memory: "384Mi"

# ────────────────────────────────────────────────────────────────
# HUBBLE: Observability
# ────────────────────────────────────────────────────────────────
hubble:
  enabled: true
  
  relay:
    enabled: true
    hubblePeerService: ""
    insecure: true
  ui:
    enabled: true
    ingress:
      enabled: false # We'll expose via port-forward or Tailscale
  metrics:
    enabled:
      - dns:query;ignoreAAAA
      - drop
      - tcp
      - flow
      - icmp
      - http
      - port-distribution
      - hubble-self-observability

# ────────────────────────────────────────────────────────────────
# PROMETHEUS
# ────────────────────────────────────────────────────────────────
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true
    trustCRDsExist: true

operator:
  prometheus:
    enabled: true
  resources:
    requests:
      cpu: "50m"
      memory: "64Mi"
    limits:
      cpu: "200m"
      memory: "128Mi"

# ────────────────────────────────────────────────────────────────
# SAFETY & COMPATIBILITY
# ────────────────────────────────────────────────────────────────
rollOutCiliumPods: true
upgradeCompatibility: "1.15"

# Disable features that conflict with Tailscale
enableNetfilterController: false
enableBandwidthManager: false
enableHostReachableServices: false

# ────────────────────────────────────────────────────────────────
# Security Context
# ────────────────────────────────────────────────────────────────
networkPolicy:
  enabled: true
  default: "deny"

securityContext:
  privileged: false
