# loki-values.yaml
deploymentMode: SingleBinary

# -------------------------------------
# SINGLE BINARY CONFIGURATION
# -------------------------------------
singleBinary:
  replicas: 1
  persistence:
    enabled: true
    size: 2Gi
    storageClass: "longhorn"
  resources:
    requests:
      cpu: 100m
      memory: 512Mi # Combined memory of read/write/backend
  
  # Load AWS/MinIO Credentials
  extraArgs:
    - -config.expand-env=true
  extraEnvFrom:
    - secretRef:
        name: loki-s3-secrets

  # -------------------------------------
  # STORAGE & CACHE VOLUMES (Ephemeral)
  # -------------------------------------
  # Using emptyDir as requested. Warning: If the pod restarts, 
  # logs not yet flushed to S3 will be lost because WAL is ephemeral.
  extraVolumes:
    - name: loki-data
      emptyDir: {}
  extraVolumeMounts:
    - name: loki-data
      mountPath: /loki
      
# -------------------------------------
# DISABLE MICROSERVICES
# -------------------------------------
gateway:
  enabled: false # Single binary handles traffic directly
backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0
ingester:
  replicas: 0
querier:
  replicas: 0
queryFrontend:
  replicas: 0
queryScheduler:
  replicas: 0
distributor:
  replicas: 0
compactor:
  replicas: 0 # Disabled as a standalone service (runs inside singleBinary)
indexGateway:
  replicas: 0
bloomCompactor:
  replicas: 0
bloomGateway:
  replicas: 0

# -------------------------------------
# LOKI APP CONFIGURATION
# -------------------------------------
loki:
  auth_enabled: false

  commonConfig:
    replication_factor: 1
    path_prefix: /loki
    ring:
      kvstore:
        store: inmemory

  # Schema Config
  schemaConfig:
    configs:
      - from: "2024-04-01"
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  # -------------------------------------
  # S3 / MINIO CONFIGURATION
  # -------------------------------------
  storage:
    type: s3
    bucketNames:
      chunks: loki-chunks
      ruler: loki-ruler
      admin: loki-admin
    s3:
      endpoint: minio-api.kwadwolabs.cloud
      region: af-johannesburg-1
      s3ForcePathStyle: true
      insecure: false
      # Credentials injected via env vars from 'loki-s3-secrets'
      accessKeyId: "${AWS_ACCESS_KEY_ID}"
      secretAccessKey: "${AWS_SECRET_ACCESS_KEY}"

  # -------------------------------------
  # COMPONENT CONFIG
  # -------------------------------------
  
  # TSDB Shipper (Manages Index in S3)
  storageConfig:
    tsdb_shipper:
      active_index_directory: /loki/tsdb-index
      cache_location: /loki/tsdb-cache
      cache_ttl: 24h

  # Compactor (Runs inside the single binary now)
  compactor:
    working_directory: /loki/compactor
    compaction_interval: 10m 
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    delete_request_store: s3

  # Ingester (Controls flushing to S3)
  ingester:
    chunk_idle_period: 5m
    chunk_retain_period: 30s
    wal:
      dir: /loki/wal
      enabled: true # Highly recommended enabling WAL for SingleBinary
      replay_memory_ceiling: 4GB

  limits_config:
    # Allow older logs to be ingested (since Promtail is catching up)
    reject_old_samples: true
    reject_old_samples_max_age: 168h
    
    # ðŸš€ INCREASE THESE LIMITS ðŸš€
    # Default is 4MB, we are bumping to 50MB to handle the startup burst
    ingestion_rate_mb: 50
    ingestion_burst_size_mb: 100
    
    # Per-stream limits (optional but good safety)
    per_stream_rate_limit: 5MB
    per_stream_rate_limit_burst: 15MB

    allow_structured_metadata: true
    volume_enabled: true
    retention_period: 672h
    max_query_length: 721h
    max_query_parallelism: 32

  ruler:
    storage:
      type: s3

# Disable built-in MinIO
minio:
  enabled: false
