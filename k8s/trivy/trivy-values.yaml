# trivy-values.yaml

trivy:
  # Switch to Client/Server mode
  mode: ClientServer
  
  # Point to your external Docker Compose instance via Tailscale IP
  serverURL: "http://100.102.159.43:4954"

  # Force Jobs to use Host Network (Bridges to Tailscale)
  podSpec:
    hostNetwork: true
    dnsPolicy: ClusterFirstWithHostNet

    # Allow the pod to run as Root to fix permission issues
    securityContext:
      runAsUser: 0
      runAsGroup: 0
      fsGroup: 0
    
    # Add this to ensure the container doesn't try to drop privileges
    containers:
      - name: trivy
        securityContext:
          allowPrivilegeEscalation: true
          privileged: true
          readOnlyRootFilesystem: false

  # Inject the DNS fix into the Scanner Environment
  env:
    - name: GODEBUG
      value: "netdns=go"
    # Disable internal DB download (We are using ClientServer mode!)
    - name: TRIVY_SKIP_DB_UPDATE
      value: "true"
    - name: TRIVY_SKIP_JAVA_DB_UPDATE
      value: "true"

  # Image Pull Secrets
  registries:
  - name: "index.docker.io"  # Matches 'docker.io' in your secret
    auth:
      secretName: "trivy-registry-auth"  # The new secret we just created
      usernameKey: "username"            # Matches --from-literal=username
      passwordKey: "password"            # Matches --from-literal=password
  
  # Catch explicit "docker.io/..."
  - name: "docker.io"
    auth:
      secretName: "trivy-registry-auth"
      usernameKey: "username"
      passwordKey: "password"
  
  # (Optional) Server Token
  # serverToken: "mysecret"

  # --- CORRECTED LOCATION ---
  # Resource limits for the actual SCANNER JOBS (the ephemeral pods).
  # This protects your worker nodes from CPU spikes during scans.
  resources:
    requests:
      cpu: 100m
      memory: 500Mi   # Increased from 100Mi to ensure it starts with enough room
    limits:
      cpu: 1000m      # Allow it to burst to 1 CPU to finish faster
      memory: 2Gi

operator:
  # Disable the built-in StatefulSet server since you are hosting it externally
  builtInTrivyServer: false

  # Job Timeouts
  # The operator needs to wait longer for the remote job to report back over the VPN.
  scanJobTimeout: "20m"
  
  # Concurrency
  # Lower concurrency to prevent saturating the Tailscale tunnel bandwidth.
  scanJobsConcurrentLimit: 2

  # STOP deleting jobs immediately. Keep them for 1 hour (1h) so we can debug.
  scanJobTTL: 1h

# Node Collector scans the node OS itself.
nodeCollector:
  enabled: true